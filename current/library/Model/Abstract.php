<?php/** * 澳底國小網站程式 * * LICENSE * * 本程式遵循GNU/GPL v3規範，詳情請見http://www.gnu.org/licenses/gpl.txt * * @copyright  2008 ottokang * @license    http://www.gnu.org/licenses/gpl.txt   GNU/GPL License 3 *//** * Model_Abstract * * 整合Form、Table的操作與存取 */abstract class Model_Abstract{    /**     * @var object 存取的表單物件     * access protected     */    protected $_form;        /**     * @var string 表單類別     * access protected     */    protected $_formClass;        /**     * @var object 資料庫Table物件     * access protected     */    protected $_table;        /**     * @var string 資料庫Table類別     * access protected     */    protected $_tableClass;        /**     * @var object Model的資料     * access protected     */    protected $_data = array();        /**     * @var string 訊息     * access protected     */    protected $_message;        /**     * @var string 表單類型     * access protected     */    protected $_formType;    /**     * 檢查ID     * @param string $id ID     * @return bool 結果     */    protected function _checkId($id)    {        if (intval($id) > 0) {            return true;        } else {            $this->setMessage('ID錯誤');            return false;        }    }        /**     * 新增資料     * @param array $data 附加的資料     */    public function addData($data)    {        $this->_data = array_merge($this->_data, $data);    }        /**     * 驗證POST資料     * @return bool 驗證結果     */    public function isValid()    {        if (!$this->getForm()->isValid($_POST)) {            $this->setMessage('表單資料輸入錯誤，請檢查');            return false;        } else {            $this->getForm()->populate($_POST);            return true;        }    }    /**     * 從資料庫設定表單資料     * @param int $id 資料庫ID     */    public function setFormById($id)    {        if ($this->_checkId($id)) {            if ($dataRow = $this->getTable()->find($id)->current()) {                $this->getForm()->populate($dataRow->toArray());                return true;            } else {                $this->setMessage('查無ID資料');                return false;            }        } else {            return false;        }    }        /**     * 設定表單類型     * @param string 表單類型     */    public function setFormType($formType)    {        $this->_formType = $formType;    }        /**     * 設定訊息     * @param string $message 錯誤訊息     * @return object $this     */    public function setMessage($message)    {        $this->_message = $message;        return $this;    }        /**     * 取得資料庫Table物件     * @return object 資料庫Table物件     */    public function getTable()    {        if (!is_object($this->_table)) {            $tableClass = 'Table_' . $this->_tableClass;            $this->_table = new $tableClass;        }        return $this->_table;    }        /**     * 取得表單物件     * @return object 表單物件     */    public function getForm()    {        if (!is_object($this->_form)) {            $formClass = 'Form_' . $this->_formClass;            $this->_form = new $formClass($this->_formType);        }        return $this->_form;    }        /**     * 取得Model資料     * @return array Model資料     */    private function _getData()    {        if ($this->_form) {            return array_merge($this->_form->getValues(), $this->_data);        } else {            return $this->_data;        }    }        /**     * 取得訊息     * @return string 訊息     */    public function getMessage()    {        return $this->_message;    }        /**     * 執行新增工作，設定訊息     */    public function add()    {        $message = $this->getTable()->addData($this->_getData());        $this->setMessage($message);    }    /**     * 執行更新工作，設定訊息     * @param int $id ID     */    public function update($id)    {        if ($this->_checkId($id)) {            $message = $this->getTable()->updateData($this->_getData(), $id);            $this->setMessage($message);        }    }    /**     * 執行刪除工作，設定訊息     * @param int $id ID     */    public function delete($id)    {        if ($this->_checkId($id)) {            $message = $this->getTable()->deleteData($id);            $this->setMessage($message);        }    }}?>